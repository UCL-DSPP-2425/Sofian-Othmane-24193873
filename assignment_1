# Libraries
library(dplyr)
library(ggplot2)
library(readr)
library(gganimate)

# Load dataset
url <- "https://www.dropbox.com/scl/fi/9d6ctufur3g72nfdtneea/countypres_2000-2020.csv?rlkey=vm0mtz12wgh6qxsgf7ops6pjx&dl=1"
election_data <- read_csv(url)

# Filter 2020 election results
election_2020 <- election_data %>%
  filter(year == 2020)

# Summarize votes by state and party, calculate winner
state_summary <- election_2020 %>%
  group_by(state, party) %>%
  summarize(votes = sum(candidatevotes), .groups = 'drop') %>%
  pivot_wider(names_from = party, values_from = votes, values_fill = 0) %>%
  mutate(winner = ifelse(DEMOCRAT > REPUBLICAN, "Democrat", "Republican"))

# Load state boundaries and prepare for merging
states <- map_data("state")
state_summary$state <- tolower(state_summary$state)
state_results <- merge(states, state_summary, by.x = "region", by.y = "state")

# Calculate centroids for label placement
state_centroids <- state_results %>%
  group_by(region) %>%
  summarize(long = mean(range(long)), lat = mean(range(lat)), winner = first(winner))

# Plot state winners
state_winners_plot <- ggplot() +
  geom_polygon(data = state_results, aes(long, lat, group = group, fill = winner), color = "#CEC7C7") +
  geom_text(data = state_centroids, aes(long, lat, label = toupper(substr(region, 1, 2))), 
            size = 2.5, color = "white", fontface = "bold") +
  scale_fill_manual(values = c("Democrat" = "#4646ff", "Republican" = "#ff4848"), name = "Party") +
  theme_void() +
  labs(title = "2020 US Election: State Winners") +
  coord_map() +
  expand_limits(x = c(-125, -65), y = c(25, 50))

# Save state winners plot
ggsave("state_winners_2020.png", plot = state_winners_plot, width = 10, height = 6, bg = "white")

# Calculate Republican vote share
state_summary <- state_summary %>%
  mutate(rep_share = REPUBLICAN / (DEMOCRAT + REPUBLICAN) * 100)

# Merge with state boundaries
state_results <- merge(states, state_summary, by.x = "region", by.y = "state")

# Calculate centroids for Republican vote share map
state_centroids <- state_results %>%
  group_by(region) %>%
  summarize(long = mean(range(long)), lat = mean(range(lat)), rep_share = first(rep_share))

# Plot Republican vote share
rep_vote_share_plot <- ggplot() +
  geom_polygon(data = state_results, aes(long, lat, group = group, fill = rep_share), color = "#fffafaa6") +
  geom_text(data = state_centroids, aes(long, lat, label = toupper(substr(region, 1, 2))), 
            size = 2.5, color = "black", fontface = "bold") +
  scale_fill_gradient(low = "white", high = "red", name = "Republican Share") +
  theme_void() +
  labs(title = "2020 US Election: Republican Vote Share (%)") +
  coord_map() +
  expand_limits(x = c(-125, -65), y = c(25, 50))

# Save Republican vote share plot
ggsave("republican_vote_share_2020.png", plot = rep_vote_share_plot, width = 10, height = 6, bg = "white")

# Summarize county results (2000-2020)
county_results <- election_data %>%
  group_by(year, county_name) %>%
  summarize(dem_votes = sum(candidatevotes[party == "DEMOCRAT"]),
            rep_votes = sum(candidatevotes[party == "REPUBLICAN"]),
            winner = ifelse(dem_votes > rep_votes, "Democrat", "Republican"), .groups = 'drop')

# Load and merge county boundaries
counties <- map_data("county")
county_results$county_name <- tolower(county_results$county_name)
county_results_map <- merge(counties, county_results, by.x = "subregion", by.y = "county_name")

# Plot county-level results, faceted by year
county_facet_plot <- ggplot(county_results_map, aes(long, lat, group = group, fill = winner)) +
  geom_polygon(color = "#0000001a") +
  scale_fill_manual(values = c("Democrat" = "blue", "Republican" = "red")) +
  facet_wrap(~ year) +
  theme(panel.background = element_rect(fill = "white", color = NA)) +
  labs(title = "US Presidential Election Results by County (2000-2020)")

# Save county election results plot
ggsave("county_election_results_2000_2020.png", plot = county_facet_plot, width = 10, height = 8)

# Create animated election map (2000-2020)
county_animation <- ggplot(county_results_map, aes(long, lat, group = group, fill = winner)) +
  geom_polygon(color = "#0000003f") +
  scale_fill_manual(values = c("Democrat" = "blue", "Republican" = "red")) +
  labs(title = "US Presidential Election Results: {frame_time}") +
  theme_void() +
  transition_time(year) +
  ease_aes('linear')

# Save animation as GIF
anim_save("us_election_animation_2000_2020.gif", animation = county_animation, fps = 2, duration = 10, width = 800, height = 600)

